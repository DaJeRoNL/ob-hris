<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruitment CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Raleway:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* --- POLISHED "AERO" STYLES v50.0 - AUTH GUARD --- */

        /* 1. Base Styles */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Raleway', sans-serif;
            font-weight: 400;
            background-image: radial-gradient(at 0% 100%, rgba(79, 70, 229, 0.15), transparent 50%),
                              radial-gradient(at 100% 0%, rgba(37, 99, 235, 0.1), transparent 50%),
                              radial-gradient(at 50% 20%, rgba(5, 150, 105, 0.1), transparent 70%),
                              radial-gradient(at 50% 50%, rgba(139, 92, 246, 0.05), transparent 70%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            --background-scroll-y: 0px; 
            --background-scroll-y-slow: 0px;
            --background-scroll-y-xslow: 0px;
            background-position-y: var(--background-scroll-y), var(--background-scroll-y-slow), var(--background-scroll-y), var(--background-scroll-y-xslow);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
             overflow-x: hidden; 
             opacity: 0;
             transition: opacity 0.3s ease-in-out;
        }
        body.auth-ready {
            opacity: 1;
        }
        .font-header {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* 2. Card Styles */
        .aero-card {
            border-radius: 16px; border: 1px solid;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: margin 0.3s ease, border-radius 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease, z-index 0s linear 0.3s; 
            animation: fadeIn 0.5s ease-out backwards;
            position: relative; overflow: hidden; z-index: 10;
        }
        /* Attached cards state */
        .aero-card:not(.expanded):not(:last-child) {
            border-bottom: 1px solid;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .aero-card:not(.expanded):not(:first-child) {
             border-top-left-radius: 0;
             border-top-right-radius: 0;
             margin-top: -1px; /* Overlap borders */
        }
        /* Expanded card state */
        .aero-card.expanded {
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-radius: 16px !important; 
            z-index: 30; 
             transition-delay: 0s; 
        }
        /* Adjacent card rounding */
        .aero-card.round-bottom-corners:not(.expanded) {
             border-bottom-left-radius: 16px;
             border-bottom-right-radius: 16px;
        }
         .aero-card.round-top-corners:not(.expanded) {
             border-top-left-radius: 16px;
             border-top-right-radius: 16px;
         }

        /* Card Glow */
        .aero-card::before { 
            content: ''; position: absolute; inset: 0;
            border-radius: inherit; 
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; z-index: 0;
        }
        .aero-card:hover::before { opacity: 1; }
        .aero-card.expanded:hover::before { 
             opacity: 0 !important; 
        } 
        .aero-card > * { position: relative; z-index: 1; }
        
        /* Card Hover */
        .aero-card:hover:not(.expanded) {
             z-index: 25; 
             transition-delay: 0s; 
        }
        .aero-card:hover {
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
            transform: translateY(-4px) scale(1.01); 
        }
        .aero-card.expanded:hover {
            transform: none !important;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37) !important;
        }
        html:not(.dark) .aero-card.expanded:hover {
             box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.05) !important;
        }

        /* Notes Card Styling */
        .notes-card {
            overflow: hidden; 
            box-shadow: none !important; 
        }
        .notes-card:hover {
            transform: none !important; 
        }
        .aero-card.expanded .notes-card {
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }


        /* 3. Input Styles */
        .aero-input {
            border: 1px solid; border-radius: 12px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        .aero-input:focus { outline: none; }

        /* 4. Status Pill Styles */
        .status-pill { padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 500; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.2); color: #fff; }
        .status-Active { background-color: #22c55e; } .status-OnHold { background-color: #f59e0b; } .status-Closed, .status-Lost { background-color: #ef4444; } .status-Interview { background-color: #3b82f6; } .status-Offer { background-color: #a855f7; } .status-Sourced, .status-Contacted { background-color: #6b7280; }
        .status-dot { position: absolute; top: 1rem; right: 1rem; width: 0.625rem; height: 0.625rem; background-color: #22c55e; border-radius: 99px; border: 2px solid; z-index: 2; }

        /* 5. Button Styles */
        .action-button { background-color: #8b5cf6; border-radius: 10px; font-weight: 500; color: white; transition: all 0.3s ease; position: relative; }
        .action-button:hover { background-color: #a78bfa; box-shadow: 0 0 20px 0 rgba(139, 92, 246, 0.5); transform: scale(1.03); }
        .action-button .btn-text { transition: opacity 0.2s ease; }
        .action-button .btn-spinner { position: absolute; top: 50%; left: 50%; margin-top: -10px; margin-left: -10px; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.5); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; opacity: 0; transition: opacity 0.2s ease; }
        .action-button.is-loading .btn-text { opacity: 0; } .action-button.is-loading .btn-spinner { opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 6. Animations & Transitions */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .details-collapsed { max-height: 0; padding-top: 0; opacity: 0; }
        .details-expanded { max-height: 800px; padding-top: 20px; opacity: 1; }
        .page-transition { transition: opacity 0.3s ease-in-out; width: 100%; position: absolute; top: 0; left: 0; right: 0; }
        .page-hidden { opacity: 0; pointer-events: none; }
        .page-visible { opacity: 1; position: relative; } 
        #page-container { position: relative; } 

        /* 7. Scrollbar */
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #a78bfa; }

        /* 8. Sidebar & Theme Toggle */
        .sidebar, .theme-toggle, .card-action-button { transition: all 0.3s ease; }
        .sidebar-icon, .theme-toggle { position: relative; display: flex; align-items: center; justify-content: center; width: 56px; height: 56px; border-radius: 12px; border: 1px solid; cursor: pointer; }
        .card-action-button { position: relative; display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 12px; border: 1px solid; cursor: pointer; flex-shrink: 0; }
        .sidebar-icon.active { background-color: #2563eb; color: #fff; box-shadow: 0 0 20px 0 rgba(37, 99, 235, 0.5); border-color: #2563eb; } /* Light theme blue */
        .theme-toggle .icon-sun { display: none; } .theme-toggle .icon-moon { display: block; }
        .theme-toggle .theme-toggle-icon-wrapper { transition: transform 0.3s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .theme-toggle.toggling .theme-toggle-icon-wrapper { transform: rotate(-90deg); }
        .sidebar-tooltip { display: block; text-align: center; font-size: 12px; font-weight: 500; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; height: 0; opacity: 0; transition: all 0.2s ease-in-out; }
        .sidebar-item-group:hover .sidebar-tooltip { height: 1.25rem; opacity: 1; margin-top: 4px; } 
        #sidebar-trigger > div { transition: all 0.3s ease; }
        
        /* Sidebar Secondary Buttons (Hover reveal) */
        .sidebar-secondary-buttons {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transform: translateY(-10px); 
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out 0.1s, transform 0.3s ease-out; 
            display: flex; 
            justify-content: center; 
            gap: 0.5rem; 
            margin-top: 0.5rem; 
            width: 100%; 
            pointer-events: none; 
        }
        .sidebar-item-group:hover .sidebar-secondary-buttons { 
            max-height: 50px; 
            opacity: 1;
            transform: translateY(0); 
            transition-delay: 0.1s; 
            pointer-events: auto; 
        }
         .sidebar-secondary-btn {
            width: 36px; height: 36px; border-radius: 8px; border: 1px solid;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease-out; 
            cursor: pointer;
            flex-shrink: 0; 
        }


        /* 9. Empty State */
        .empty-state-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; grid-column: 1 / -1; }

        /* 10. Header Styles */
        #global-sticky-header { position: sticky; top: 0; z-index: 40; pointer-events: none; }
        #global-sticky-header > div { pointer-events: auto; display: flex; justify-content: flex-end; padding: 1rem; }
        #leads-sticky-header { position: sticky; top: 72px; z-index: 20; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .page-header { transition: font-size 0.3s ease-in-out; }
        .page-subtitle { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, height 0.3s ease-in-out; overflow: hidden; will-change: transform, opacity, height; }

        /* 11. Card Detail Readability & Layout */
        .card-details-content { position: relative; z-index: 2; padding-bottom: 1rem; } 
        .card-details-grid { min-height: 400px; display: grid; grid-template-rows: 1fr auto; } 
        .card-details-content label, .card-details-content p, 
        .notes-card p, .card-details-content a, .notes-card label {
            opacity: 1 !important; 
        }

        /* 12. Dark Mode */
        html.dark body { background-color: #111827; color: #E5E7EB; }
        html.dark .aero-card { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%); border-color: rgba(255, 255, 255, 0.05); color: #E5E7EB; }
        html.dark .aero-card:hover { border-color: rgba(255, 255, 255, 0.1); }
        html.dark .aero-card:not(.expanded):not(:last-child) { border-bottom-color: rgba(255, 255, 255, 0.1); } 
        html.dark .aero-card::before { background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255, 255, 255, 0.02), transparent 25%); }
        html.dark .aero-input { background: rgba(17, 24, 39, 0.5); border-color: rgba(255, 255, 255, 0.1); color: #FFFFFF; } 
        html.dark .aero-input::placeholder { color: #9ca3af; } 
        html.dark .aero-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.4); }
        html.dark .font-header { color: #fff; }
        html.dark .sidebar { background: rgba(31, 41, 55, 0.2); backdrop-filter: blur(20px) saturate(120%); -webkit-backdrop-filter: blur(20px) saturate(120%); border-right-color: transparent; box-shadow: 5px 0 20px -5px rgba(0, 0, 0, 0.3); }
        html.dark .sidebar-icon, html.dark .theme-toggle, html.dark .sidebar-secondary-btn { color: #9ca3af; background: rgba(17, 24, 39, 0.5); border-color: rgba(255, 255, 255, 0.05); }
        html.dark .sidebar-icon:hover, html.dark .theme-toggle:hover, html.dark .sidebar-secondary-btn:hover { color: #fff; background: rgba(139, 92, 246, 0.3); border-color: rgba(139, 92, 246, 0.5); }
        html.dark #add-btn:hover { background: rgba(22, 163, 74, 0.3); border-color: rgba(22, 163, 74, 0.5); color: #fff; }
        html.dark .empty-state-card { color: #E5E7EB; } 
        html.dark ::-webkit-scrollbar-track { background: #1f2937; }
        html.dark #leads-sticky-header { background: transparent; box-shadow: none; }
        html.dark .theme-toggle .icon-sun { display: block; } html.dark .theme-toggle .icon-moon { display: none; }
        html.dark .sidebar-icon.active { border-color: #8b5cf6; background-color: #8b5cf6; } 
        html.dark .sidebar-tooltip { color: #c7d2fe; }
        html.dark .status-dot { border-color: #111827; }
        html.dark .card-action-button { color: #9ca3af; background: rgba(17, 24, 39, 0.5); border-color: rgba(255, 255, 255, 0.05); }
        html.dark .card-action-button:hover { color: #fff; background: rgba(139, 92, 246, 0.3); border-color: rgba(139, 92, 246, 0.5); }
        html.dark .card-details-content label { color: #E5E7EB; } 
        html.dark .card-details-content p, html.dark .notes-card p { color: #FFFFFF; } 
        html.dark .card-details-content a { color: #c4b5fd; } 
        html.dark .notes-card label { color: #E5E7EB; }
        html.dark .notes-card { background: rgba(17, 24, 39, 0.6); }

        /* 13. Light Mode (Deep Blue Theme) */
        html:not(.dark) body { background-color: #f0f3f8; color: #1e3a8a; } 
        html:not(.dark) .aero-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%); border-color: rgba(30, 64, 175, 0.1); color: #1e3a8a; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.05); }
        html:not(.dark) .aero-card:hover { border-color: rgba(30, 64, 175, 0.2); box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.1); }
        html:not(.dark) .aero-card:not(.expanded):not(:last-child) { border-bottom-color: rgba(30, 64, 175, 0.2); }
        html:not(.dark) .aero-card::before { background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(37, 99, 235, 0.04), transparent 30%); }
        html:not(.dark) .aero-input { background: rgba(219, 234, 254, 0.5); border-color: rgba(30, 64, 175, 0.2); color: #1f2937; } 
        html:not(.dark) .aero-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); }
        html:not(.dark) .font-header { color: #1e3a8a; } 
        html:not(.dark) .sidebar { background: rgba(240, 243, 248, 0.4); backdrop-filter: blur(20px) saturate(120%); -webkit-backdrop-filter: blur(20px) saturate(120%); border-right-color: transparent; box-shadow: 5px 0 20px -5px rgba(30, 58, 138, 0.15); }
        html:not(.dark) .sidebar-icon, html:not(.dark) .theme-toggle, html:not(.dark) .sidebar-secondary-btn { color: #1e40af; background: rgba(219, 234, 254, 0.5); border-color: rgba(30, 64, 175, 0.1); }
        html:not(.dark) .sidebar-icon:hover, html:not(.dark) .theme-toggle:hover, html:not(.dark) .sidebar-secondary-btn:hover { color: #1d4ed8; background: rgba(191, 219, 254, 0.5); border-color: rgba(30, 64, 175, 0.2); }
        html:not(.dark) #add-btn:hover { background: rgba(22, 163, 74, 0.2); border-color: rgba(22, 163, 74, 0.4); color: #15803d; }
        html:not(.dark) .empty-state-card { color: #1e3a8a; } 
        html:not(.dark) ::-webkit-scrollbar-track { background: #dbeafe; }
        html:not(.dark) #leads-sticky-header { background: transparent; box-shadow: none; }
        html:not(.dark) .theme-toggle .icon-sun { display: none; } html:not(.dark) .theme-toggle .icon-moon { display: block; }
        html:not(.dark) .sidebar-icon.active { border-color: #2563eb; background-color: #2563eb; color: #fff; } /* Blue active */
        html:not(.dark) .sidebar-tooltip { color: #1e40af; }
        html:not(.dark) .status-dot { border-color: #f0f3f8; }
        html:not(.dark) .card-action-button { color: #1e40af; background: rgba(219, 234, 254, 0.5); border-color: rgba(30, 64, 175, 0.1); }
        html:not(.dark) .card-action-button:hover { color: #1d4ed8; background: rgba(191, 219, 254, 0.5); border-color: rgba(30, 64, 175, 0.2); }
        html:not(.dark) .status-pill { color: #1e3a8a; } 
        html:not(.dark) .card-details-content label { color: #1e40af; } 
        html:not(.dark) .card-details-content p, html:not(.dark) .notes-card p { color: #172554; } 
        html:not(.dark) .card-details-content a { color: #1d4ed8; } 
        html:not(.dark) .notes-card label { color: #1e40af; } 
        html:not(.dark) .notes-card { background: rgba(219, 234, 254, 0.6); }
        html:not(.dark) .action-button { background-color: #2563eb; }
        html:not(.dark) .action-button:hover { background-color: #3b82f6; box-shadow: 0 0 20px 0 rgba(37, 99, 235, 0.5); }
        
        /* 14. Theme Transition & Modal Styles */
        #theme-transition-overlay { position: fixed; inset: 0; z-index: 9999; pointer-events: none; background-color: transparent; clip-path: circle(0% at var(--clip-x) var(--clip-y)); transition: clip-path 0.5s ease-in-out, opacity 0.3s ease-in-out; opacity: 0; }
        #theme-transition-overlay.active { clip-path: circle(150% at var(--clip-x) var(--clip-y)); opacity: 1; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        #theme-transition-overlay.fading-out { opacity: 0; }
        #add-modal-overlay { position: fixed; inset: 0; z-index: 50; background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        #add-modal-overlay.visible { opacity: 1; pointer-events: all; }
        #add-modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 51; opacity: 0; transition: all 0.3s ease-in-out; pointer-events: none; }
        #add-modal-content.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all; }
        .modal-button { background-color: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); padding: 1rem 1.5rem; border-radius: 12px; font-weight: 500; transition: all 0.3s ease; }
        .modal-button:hover { background-color: rgba(139, 92, 246, 0.3); border-color: rgba(139, 92, 246, 0.5); transform: translateY(-2px); box-shadow: 0 4px 20px 0 rgba(139, 92, 246, 0.2); }
        html:not(.dark) .modal-button { background-color: rgba(37, 99, 235, 0.1); border-color: rgba(37, 99, 235, 0.3); }
        html:not(.dark) .modal-button:hover { background-color: rgba(37, 99, 235, 0.2); border-color: rgba(37, 99, 235, 0.5); box-shadow: 0 4px 20px 0 rgba(37, 99, 235, 0.2); }

         /* 15. Smart Filter Panel */
         #smart-filter-panel {
             position: fixed; top: 0; 
             left: 6rem; /* w-24 */
             width: 300px; 
             height: 100vh;
             z-index: 35; 
             transition: transform 0.3s ease-in-out;
             transform: translateX(-100%);
             padding: 1.5rem;
             border-top-right-radius: 16px; 
             border-bottom-right-radius: 16px;
             overflow-y: auto; 
         }
         #smart-filter-panel.visible {
             transform: translateX(0);
         }
         html.dark #smart-filter-panel { background: rgba(31, 41, 55, 0.4); backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%); border-right: 1px solid rgba(255, 255, 255, 0.05); }
         html:not(.dark) #smart-filter-panel { background: rgba(238, 242, 255, 0.6); backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%); border-right: 1px solid rgba(191, 219, 254, 0.5); }
          @media (max-width: 768px) {
             #smart-filter-panel {
                 left: 0;
                 width: 80%; 
                 border-right: none;
                 box-shadow: 5px 0 15px rgba(0,0,0,0.2);
                 border-top-left-radius: 0; 
                 border-bottom-left-radius: 0;
             }
         }
         
         /* 16. NEW: Details Sidebar */
        #details-sidebar {
            position: fixed;
            top: 0; right: 0;
            width: 24rem; /* w-96 */
            height: 100vh;
            z-index: 38; 
            transition: transform 0.4s ease-in-out;
            transform: translateX(100%);
            padding: 1.5rem;
            overflow-y: auto;
        }
        #details-sidebar.visible {
            transform: translateX(0);
        }
        html.dark #details-sidebar { background: rgba(31, 41, 55, 0.4); backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%); border-left: 1px solid rgba(255, 255, 255, 0.05); }
        html:not(.dark) #details-sidebar { background: rgba(238, 242, 255, 0.6); backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%); border-left: 1px solid rgba(191, 219, 254, 0.5); }

        /* Main content push */
        main.flex-1 {
            transition: margin-right 0.4s ease-in-out;
        }
        body.details-visible main.flex-1 {
            margin-right: 24rem; 
        }
        @media (max-width: 768px) {
             #details-sidebar { width: 90%; }
             body.details-visible main.flex-1 { margin-right: 0; }
        }
        
        /* Details sidebar content */
        .detail-item { margin-bottom: 1rem; }
        .detail-item label { display: block; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; opacity: 0.7; margin-bottom: 0.25rem; }
        .detail-item p { font-size: 1rem; }
        .detail-item-notes p { white-space: pre-wrap; line-height: 1.6; }
        #changelog-content {
             max-height: 0;
             opacity: 0;
             overflow: hidden;
             transition: all 0.3s ease-out;
        }
        #changelog-content.expanded {
             max-height: 400px; 
             opacity: 1;
             margin-top: 0.5rem;
        }
    </style>
</head>
<body class="p-0 m-0">

    <!-- Main Application Wrapper -->
    <div classs="flex min-h-screen">
        
        <!-- Sidebar Wrapper -->
        <div id="sidebar-wrapper" class="fixed md:sticky top-0 h-screen z-40 group"> <!-- REMOVED hidden class -->
             <!-- MODIFIED: Increased width w-20 -> w-24 -->
            <aside id="sidebar" class="sidebar w-24 h-screen p-3 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 group-hover:-translate-x-0">
                <div class="flex flex-col items-center h-full">
                    <div class="mb-4"> <img src="https://placehold.co/48x48/0a2a4c/FFFFFF?text=PB&font=montserrat" alt="Logo" class="w-12 h-12 rounded-lg object-cover" title="PlaceByte CRM"> </div>
                    <div class="border-t w-full my-2 opacity-10" style="border-color: currentColor;"></div>
                    
                    <!-- Activity Section -->
                    <div class="sidebar-item-group group w-full my-2"> 
                         <div class="relative sidebar-icon-container"> 
                             <div id="icon-activity" class="sidebar-icon mx-auto" onclick="window.showPage('activity')"> 
                                 <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg> 
                             </div> 
                         </div>
                         <span class="sidebar-tooltip">Activity</span> 
                     </div>


                    <div class="border-t w-full my-2 opacity-10" style="border-color: currentColor;"></div>
                    
                    <!-- Leads Section -->
                     <div class="sidebar-item-group group w-full my-2">
                         <div class="relative sidebar-icon-container">
                            <div id="icon-leads" class="sidebar-icon active mx-auto" onclick="window.showPage('leads')"> 
                                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 00-3.741-.56c-.047.01-.082.022-.122.033a9.09 9.09 0 00-3.74.56m2.583-3.842a15.935 15.935 0 00-4.328 0c-.042.015-.08.03-.12.045a9.09 9.09 0 00-3.74.56m12.354-6.68a9.09 9.09 0 00-3.74-.56c-.047.01-.082.022-.122.033a9.09 9.09 0 00-3.74.56m2.583-3.842a15.935 15.935 0 00-4.328 0c-.042.015-.08.03-.12.045a9.09 9.09 0 00-3.74.56m12.354-6.68l-3.182 3.182m0 0a15.935 15.935 0 01-4.328 0m4.328 0l3.182-3.182m-3.182 3.182l-3.182 3.182" /> </svg> 
                            </div> 
                         </div>
                         <!-- Secondary Buttons moved below icon, before tooltip -->
                         <div class="sidebar-secondary-buttons">
                             <button class="sidebar-secondary-btn" title="Smart Filter" onclick="window.toggleFilterPanel()">
                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
                             </button>
                             <button class="sidebar-secondary-btn" title="Leads Activity Feed">
                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.125 1.125 0 010 2.25H5.625a1.125 1.125 0 010-2.25z" /></svg>
                             </button>
                         </div>
                         <span class="sidebar-tooltip">Leads</span> 
                     </div>
                    
                    <!-- Accounts Section -->
                     <div class="sidebar-item-group group w-full my-2">
                         <div class="relative sidebar-icon-container">
                             <div id="icon-accounts" class="sidebar-icon mx-auto" onclick="window.showPage('accounts')"> 
                                 <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" /> </svg> 
                             </div> 
                         </div>
                          <div class="sidebar-secondary-buttons">
                              <button class="sidebar-secondary-btn" title="Smart Filter" onclick="window.toggleFilterPanel()">
                                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
                             </button>
                             <button class="sidebar-secondary-btn" title="Accounts Activity Feed">
                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.125 1.125 0 010 2.25H5.625a1.125 1.125 0 010-2.25z" /></svg>
                             </button>
                         </div>
                         <span class="sidebar-tooltip">Accounts</span> 
                     </div>
                    
                    <!-- Talent Section -->
                     <div class="sidebar-item-group group w-full my-2">
                         <div class="relative sidebar-icon-container">
                             <div id="icon-talent" class="sidebar-icon mx-auto" onclick="window.showPage('talent')"> 
                                 <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423L16.5 15.75l.394 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.394a2.25 2.25 0 00-1.423 1.423z" /> </svg> 
                             </div> 
                         </div>
                         <div class="sidebar-secondary-buttons">
                             <button class="sidebar-secondary-btn" title="Smart Filter" onclick="window.toggleFilterPanel()">
                                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
                             </button>
                             <button class="sidebar-secondary-btn" title="Talent Activity Feed">
                                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.125 1.125 0 010 2.25H5.625a1.125 1.125 0 010-2.25z" /></svg>
                             </button>
                         </div>
                         <span class="sidebar-tooltip">Talent</span> 
                     </div>
                    
                    <div class="mt-auto"></div> 
                    
                    <!-- Add Button (No secondary buttons) -->
                    <div class="sidebar-item-group group w-full my-2"> 
                        <div class="relative sidebar-icon-container"> 
                             <div id="add-btn" class="sidebar-icon mx-auto"> 
                                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> </svg> 
                             </div> 
                         </div>
                         <!-- No tooltip for Add -->
                     </div>
                     
                     <!-- Sign Out Button -->
                    <div class="sidebar-item-group group w-full my-2"> <!-- REMOVED hidden class -->
                        <div class="relative sidebar-icon-container"> 
                             <div id="sign-out-btn" class="sidebar-icon mx-auto" title="Sign Out"> 
                                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                                </svg>
                             </div> 
                         </div>
                     </div>


                </div>
            </aside>
            <div id="sidebar-trigger" class="md:hidden absolute top-1/2 -translate-y-1/2 left-0 transition-opacity duration-300 ease-in-out opacity-100 group-hover:opacity-0" style="pointer-events: none;">
                 <div class="w-6 h-24 flex items-center justify-center rounded-r-lg bg-violet-500/50 backdrop-blur-sm transform-gpu"> <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /> </svg> </div>
            </div>
        </div>

        <!-- NEW: Smart Filter Panel -->
        <div id="smart-filter-panel" class="aero-card">
            <h3 class="font-header text-xl mb-4">Smart Filters</h3>
            <p class="text-sm opacity-80">Filter options will go here...</p>
        </div>

        <!-- Main Content Wrapper -->
        <main class="flex-1 overflow-y-auto relative md:pl-24"> <!-- REMOVED hidden class -->
            <!-- NEW: Global Sticky Header -->
            <div id="global-sticky-header">
                <div class="max-w-4xl mx-auto">
                    <button id="theme-toggle-btn" class="theme-toggle" title="Toggle Theme">
                        <div class="theme-toggle-icon-wrapper">
                            <svg class="icon-sun w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m8.66-15.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m15.66 8.66l-.707-.707M4.04 4.04l-.707-.707M12 16a4 4 0 100-8 4 4 0 000 8z" /> </svg>
                            <svg class="icon-moon w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /> </svg>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Page Container -->
            <div id="page-container" class="relative">
                <!-- PAGE 1: LEADS -->
                <div id="page-leads" class="page-transition page-visible">
                    <!-- Leads Specific Sticky Header (Search) -->
                    <div id="leads-sticky-header" class="p-4 md:px-8 md:pt-0 md:pb-4">
                        <div class="max-w-4xl mx-auto">
                            <header class="mb-4 flex justify-between items-start">
                                <div>
                                    <h1 class="page-header font-header text-3xl">Leads Dashboard</h1>
                                    <p class="page-subtitle text-sm opacity-0 transition-opacity duration-500">Loading user data...</p>
                                </div>
                                <div id="loading-message" class="text-violet-400 animate-pulse mt-3"> Loading data... </div>
                            </header>
                            <div> <input type="text" id="search-box" class="aero-input w-full p-3 text-base" placeholder="Search by name, company, or role..."> </div>
                        </div>
                    </div>
                    <!-- Leads Content -->
                    <div class="p-4 md:p-8 pt-0 md:pt-0">
                        <div class="max-w-4xl mx-auto">
                             <!-- MODIFIED: Removed grid-cols-2 -->
                            <main id="card-container" class="grid grid-cols-1 gap-0"></main>
                        </div>
                    </div>
                </div>
                
                <!-- PAGE 4: ACTIVITY -->
                <div id="page-activity" class="page-transition page-hidden">
                    <div class="p-4 md:p-8">
                        <div class="max-w-4xl mx-auto">
                            <header class="mb-6"> <h1 class="page-header font-header text-3xl">Activity</h1> <p class="page-subtitle text-sm opacity-70">Recent updates and actions</p> </header>
                            <div class="aero-card p-10 text-center"> <h2 class="font-header text-2xl mb-2">Activity Page</h2> <p>This page is under construction.</p> </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE 2: ACCOUNTS -->
                <div id="page-accounts" class="page-transition page-hidden">
                    <div class="p-4 md:p-8">
                        <div class="max-w-4xl mx-auto">
                            <header class="mb-6"> <h1 class="page-header font-header text-3xl">Accounts</h1> <p class="page-subtitle text-sm opacity-70">Client and contract management</p> </header>
                            <div class="aero-card p-10 text-center"> <h2 class="font-header text-2xl mb-2">Accounts Page</h2> <p>This page is under construction.</p> </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE 3: TALENT -->
                <div id="page-talent" class="page-transition page-hidden">
                    <div class="p-4 md:p-8">
                        <div class="max-w-4xl mx-auto">
                            <header class="mb-6"> <h1 class="page-header font-header text-3xl">Talent Pool</h1> <p class="page-subtitle text-sm opacity-70">Search and manage your candidates</p> </header>
                            <div class="aero-card p-10 text-center"> <h2 class="font-header text-2xl mb-2">Talent Page</h2> <p>This page is under construction.</p> </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Page Container -->
        </main>

        <!-- NEW: Details Sidebar -->
        <div id="details-sidebar" class="aero-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-header text-2xl">Lead Details</h2>
                <button id="close-details-btn" class="theme-toggle" title="Close Details">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="detail-item">
                    <label>Name</label>
                    <p id="detail-name">Lead Name Here</p>
                </div>
                <div class="detail-item">
                    <label>Company</label>
                    <p id="detail-company">Company Name Here</p>
                </div>
                 <div class="detail-item">
                    <label>Role</label>
                    <p id="detail-role">Role Here</p>
                </div>
                <div class="detail-item">
                    <label>Phone</label>
                    <p id="detail-phone">(123) 456-7890</p>
                </div>
                <div class="detail-item">
                    <label>Email</label>
                    <p id="detail-email">lead.email@example.com</p>
                </div>
                <div class="detail-item detail-item-notes">
                    <label>Notes</label>
                    <p id="detail-notes" class="aero-card notes-card p-3">Detailed notes will go here. This section allows for more text than the small card view.
                    
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                </div>
                
                <!-- Expandable Change Log -->
                <div class="detail-item">
                    <button id="changelog-toggle" class="flex justify-between items-center w-full text-left">
                        <label>Change Log</label>
                        <svg id="changelog-arrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="changelog-content" class="text-sm opacity-80">
                        <p><b>Today:</b> Status changed to 'Interview'.</p>
                        <p><b>Yesterday:</b> Note added by Amy.</p>
                        <p><b>Oct 26:</b> Lead Sourced.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden fixed bottom-5 right-5 aero-card p-4"></div>
    </div>

    <!-- Theme Overlay -->
    <div id="theme-transition-overlay"></div>

    <!-- Add Modal -->
    <div id="add-modal-overlay">
        <div id="add-modal-content" class="aero-card p-6 w-full max-w-sm">
            <h2 class="font-header text-2xl mb-6 text-center">Add New</h2>
            <div class="space-y-4">
                <button class="modal-button w-full">Add Contact</button>
                <button class="modal-button w-full">Add Candidate</button>
            </div>
        </div>
    </div>

    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, // MODIFIED: Back to simple getAuth
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged,
            // REMOVED: initializeAuth, browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // MODIFIED: Wrap all code in DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. index.html");
            
            // --- Global Vars ---
            const appId = '1:235015794887:web:df62ef5c2dcd86dd9d0ee2'; 
            const firebaseConfig = { apiKey: "AIzaSyBMjvZ-y6EmaDceeNWxoKuN62JsTQGqb04", authDomain: "placebyte-lac.firebaseapp.com", projectId: "placebyte-lac", storageBucket: "placebyte-lac.appspot.com", messagingSenderId: "235015794887", appId: appId };
            
            let db, auth, userId = null; 
            let activeCardId = null; 
            let allCandidates = [];
            let filterFn = () => true;
            let unsubscribeDataListener = null; 

            // --- DOM Elements ---
            const cardContainer = document.getElementById('card-container');
            const loadingMessageEl = document.getElementById('loading-message');
            const userInfoDisplay = document.querySelector('#page-leads .page-subtitle'); 
            const searchBox = document.getElementById('search-box');
            const messageBox = document.getElementById('message-box');
            const mainScroller = document.querySelector('main.flex-1');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const leadsStickyHeader = document.getElementById('leads-sticky-header'); 
            const themeOverlay = document.getElementById('theme-transition-overlay');
            const addBtn = document.getElementById('add-btn');
            const addModalOverlay = document.getElementById('add-modal-overlay');
            const addModalContent = document.getElementById('add-modal-content');
            const pageContainer = document.getElementById('page-container');
            const smartFilterPanel = document.getElementById('smart-filter-panel'); 
            const detailsSidebar = document.getElementById('details-sidebar');
            const closeDetailsBtn = document.getElementById('close-details-btn');
            const changelogToggle = document.getElementById('changelog-toggle');
            const changelogContent = document.getElementById('changelog-content');
            const changelogArrow = document.getElementById('changelog-arrow');
            const signOutBtn = document.getElementById('sign-out-btn');
            const sidebarWrapper = document.getElementById('sidebar-wrapper');
            const mainContent = document.querySelector('main.flex-1');
            
            setLogLevel('debug');

            // --- Firebase Init ---
            const initFirebase = async () => {
                try {
                    console.log("Initializing Firebase...");
                    if (!firebaseConfig.apiKey) throw new Error("Firebase config is missing.");
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    
                    // MODIFIED: Use simple getAuth
                    auth = getAuth(app);
                    console.log("Auth initialized.");
                    
                    // --- Auth State Listener ---
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // User is signed in
                            console.log("User found:", user.uid);
                            userId = user.uid; 
                            if(userInfoDisplay) {
                                userInfoDisplay.textContent = `User: ${user.displayName || user.email}`; 
                                userInfoDisplay.classList.remove('opacity-0');
                            }
                            
                            // Show the app
                            document.body.classList.add('auth-ready'); // Fade in body
                            sidebarWrapper.classList.remove('hidden');
                            mainContent.classList.remove('hidden');
                            signOutBtn.parentElement.parentElement.classList.remove('hidden'); 

                            listenForData(userId);
                            
                        } else {
                            // No user, redirect to login page
                            console.log("No user found, redirecting to login.html");
                            window.location.href = './login.html';
                        }
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                     if(loadingMessageEl) loadingMessageEl.textContent = `Error: ${error.message}`;
                     if(userInfoDisplay) userInfoDisplay.textContent = "Error: Firebase init failed.";
                }
            };

            // --- Data Listener ---
            const listenForData = (currentUserId) => {
                if (!db || !currentUserId) return;
                
                if (unsubscribeDataListener) {
                    unsubscribeDataListener();
                }

                const collectionPath = `artifacts/${appId}/users/${currentUserId}/crm_candidates`;
                console.log("Listening to path:", collectionPath);
                const q = query(collection(db, collectionPath));

                unsubscribeDataListener = onSnapshot(q, (snapshot) => {
                    if(loadingMessageEl) loadingMessageEl.textContent = `Syncing...`;
                    allCandidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allCandidates.sort((a, b) => {
                        const dateA = a.createdAt?.timestampValue ? new Date(a.createdAt.timestampValue) : new Date(0);
                        const dateB = b.createdAt?.timestampValue ? new Date(b.createdAt.timestampValue) : new Date(0);
                        return dateB - dateA;
                    });
                    renderData(allCandidates.filter(filterFn)); 
                    if(loadingMessageEl) {
                        loadingMessageEl.textContent = `${allCandidates.length} Records Loaded`;
                        setTimeout(() => { if (loadingMessageEl) loadingMessageEl.classList.add('hidden'); }, 2000);
                    }
                }, (error) => {
                    console.error("Firestore snapshot error: ", error);
                     if(loadingMessageEl) loadingMessageEl.textContent = "Error: Check Firestore Rules or Path.";
                });
            };
            
            // --- Rendering ---
            const renderData = (candidates) => {
                if (!cardContainer) return; 
                cardContainer.innerHTML = '';
                if (candidates.length === 0) {
                    cardContainer.innerHTML = `
                    <div class="aero-card empty-state-card" style="animation-delay: 0s;">
                        <svg class="w-16 h-16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                        <h3 class="font-header text-xl mb-1">No Leads Found</h3> 
                        <p class="text-sm max-w-md">You are logged in, but no leads were found for your user ID.</p>
                        <p class="text-xs mt-2 opacity-70">If you just signed up, you may need to migrate your data from the old ID.</p>
                    </div>`;
                    return;
                }
                candidates.forEach((c, index) => {
                    const isExpanded = c.id === activeCardId;
                    const animationDelay = `${index * 0.07}s`;
                    const expandedClass = isExpanded ? ' expanded' : ''; 
                    cardContainer.innerHTML += createCardHTML(c, isExpanded, animationDelay, expandedClass);
                });
                 if (activeCardId) {
                    const cardEl = document.getElementById(`card-${activeCardId}`);
                    if (cardEl) updateAdjacentCorners(cardEl, true);
                 }
            };

            const sampleStatuses = ["Active", "On Hold", "Closed", "Lost", "Interview", "Offer", "Sourced", "Contacted"];
            const sampleStages = ["Sourced", "Contacted", "Screening", "Client Review", "Final Offer", "Hired"];
            
            const createCardHTML = (c, isExpanded, animationDelay, expandedClass) => { 
                const safeStatus = c.STATUS ? String(c.STATUS).replace(/\s/g, '') : 'default';
                const statusClass = `status-${safeStatus}`;
                const dropdownOptions = (currentValue, options) => {
                    let html = `<option value="${currentValue || ''}" selected>${currentValue || 'N/A'}</option>`;
                    options.filter(opt => opt !== currentValue).forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
                    return html;
                };
                
                return `
                    <div id="card-${c.id}" class="aero-card p-4 cursor-pointer${expandedClass}" data-id="${c.id}" style="animation-delay: ${animationDelay}">
                        ${c.STAGE === 'Hired' ? '<div class="status-dot" title="Stage: Hired"></div>' : ''}
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center" onclick="window.toggleCard('${c.id}')">
                            <div class="mb-2 md:mb-0"> <h2 class="font-header text-xl">${c.LeadName || 'N/A'}</h2> <p class="text-sm">${c.CompanyName || 'No Company'}</p> </div>
                            <div class="flex items-center space-x-3"> <span class="status-pill ${statusClass}">${c.STATUS || 'N/A'}</span> <span class="text-sm font-medium">${c.STAGE || 'N/A'}</span> <svg id="arrow-${c.id}" class="w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> </div>
                        </div>
                        <div id="details-${c.id}" class="overflow-hidden transition-all duration-400 ease-in-out ${isExpanded ? 'details-expanded' : 'details-collapsed'}">
                            <div class="border-t border-white/10 dark:border-indigo-700/10 card-details-content pt-4">
                                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-x-4 card-details-grid"> 
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> 
                                        <div> <label for="status-${c.id}" class="block text-xs font-medium uppercase mb-1">Status</label> <select id="status-${c.id}" class="aero-input block w-full p-2 text-sm"> ${dropdownOptions(c.STATUS, sampleStatuses)} </select> </div>
                                        <div> <label for="stage-${c.id}" class="block text-xs font-medium uppercase mb-1">Stage</label> <select id="stage-${c.id}" class="aero-input block w-full p-2 text-sm"> ${dropdownOptions(c.STAGE, sampleStages)} </select> </div>
                                        <div class="sm:col-span-2 flex items-end"> <button onclick="window.updateStatusAndStage(event, '${c.id}', this)" class="action-button w-full sm:w-auto py-2 px-4 text-sm"> <span class="btn-text">Update Status</span> <div class="btn-spinner"></div> </button> </div>
                                        <div> <label class="block text-xs font-medium uppercase mb-1">Role</label> <p class="text-sm">${c.LeadRole || ''}</p> </div>
                                        <div> <label class="block text-xs font-medium uppercase mb-1">Industry</label> <p class="text-sm">${c.Industry || ''}</p> </div>
                                        <div> <label class="block text-xs font-medium uppercase mb-1">LinkedIn</label> <a href="${c.LinkedInLink}" target="_blank" class="text-sm text-violet-500 hover:text-violet-400 truncate">${c.LinkedInLink ? 'View Profile' : ''}</a> </div>
                                        <div> <label class="block text-xs font-medium uppercase mb-1">Date Added</label> <p class="text-sm">${c.Date ? new Date(c.Date).toLocaleDateString() : ''}</p> </div>
                                    </div>
                                     <div class="flex flex-col items-end space-y-4 mb-4 pt-4 self-end"> 
                                        <button class="card-action-button" title="View" onclick="window.openDetailsSidebar('${c.id}')"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> </button>
                                        <button class="card-action-button" title="Call"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" /></svg> </button>
                                        <button class="card-action-button" title="Email"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg> </button>
                                        <button class="card-action-button" title="Edit"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg> </button>
                                        </div>
                                    <div class="md:col-span-2 p-3 aero-card notes-card"> 
                                        <label class="block text-xs font-medium uppercase mb-1">Notes</label>
                                        <p class="text-sm whitespace-pre-wrap">${c.NOTELS || 'No notes recorded.'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };


            // --- EVENT HANDLERS ---
            
            // Page Navigation (Fade transition)
            window.showPage = (pageName) => {
                const activePage = document.querySelector('.page-visible');
                const targetPage = document.getElementById(`page-${pageName}`);
                
                if (!targetPage) {
                    console.error("Target page not found:", pageName);
                    return;
                }
                if (activePage === targetPage) return; // Do nothing if clicking active page (hover handles sub-buttons)

                // Deactivate all icons first
                document.querySelectorAll('.sidebar-icon').forEach(i => i.classList.remove('active'));

                // Activate target icon
                 const targetIcon = document.getElementById(`icon-${pageName}`);
                 if (targetIcon) {
                    targetIcon.classList.add('active');
                 }

                // --- Transition Logic ---
                let activePageFadedOut = !activePage; 

                if (activePage) {
                    activePage.classList.add('page-hidden');
                    activePage.addEventListener('transitionend', function handler(event) {
                        if (event.propertyName !== 'opacity') return; 
                        activePage.classList.remove('page-visible');
                        activePage.removeEventListener('transitionend', handler);
                        activePageFadedOut = true;
                        fadeInNewPage(); 
                    }, { once: false }); 
                     setTimeout(() => {
                         if (!activePageFadedOut) {
                             console.warn("Fade out transitionend event did not fire for", activePage.id);
                             activePage.classList.remove('page-visible');
                             activePage.removeEventListener('transitionend', function handler(){}); 
                             activePageFadedOut = true;
                             fadeInNewPage();
                         }
                     }, 350); 
                }
                
                const fadeInNewPage = () => {
                     if (!activePageFadedOut) return; 
                     targetPage.classList.remove('page-hidden');
                     targetPage.classList.add('page-visible');
                     void targetPage.offsetWidth; 
                }

                if (!activePage) {
                    fadeInNewPage();
                }
               
            };

            // Helper function to update corners of adjacent cards
            const updateAdjacentCorners = (cardEl, isOpening) => {
                if (!cardEl) return; // Guard clause
                const prevSibling = cardEl.previousElementSibling;
                const nextSibling = cardEl.nextElementSibling;

                // Handle previous sibling
                if (prevSibling && prevSibling.classList.contains('aero-card')) {
                    prevSibling.classList.toggle('round-bottom-corners', isOpening);
                }
                 // Reset any previous sibling of the *old* active card if closing
                 if (!isOpening && activeCardId) {
                     const oldCardEl = document.getElementById(`card-${activeCardId}`);
                     if (oldCardEl) {
                         const oldPrevSibling = oldCardEl.previousElementSibling;
                         // Check it exists and isn't the card currently being interacted with
                         if (oldPrevSibling && oldPrevSibling.classList.contains('aero-card') && oldPrevSibling !== cardEl) { 
                             oldPrevSibling.classList.remove('round-bottom-corners');
                         }
                     }
                 }

                // Handle next sibling
                if (nextSibling && nextSibling.classList.contains('aero-card')) {
                    nextSibling.classList.toggle('round-top-corners', isOpening);
                }
                // Reset any next sibling of the *old* active card if closing
                 if (!isOpening && activeCardId) {
                     const oldCardEl = document.getElementById(`card-${activeCardId}`);
                      if (oldCardEl) {
                        const oldNextSibling = oldCardEl.nextElementSibling;
                         // Check it exists and isn't the card currently being interacted with
                        if (oldNextSibling && oldNextSibling.classList.contains('aero-card') && oldNextSibling !== cardEl) { 
                            oldNextSibling.classList.remove('round-top-corners');
                        }
                     }
                 }
            };


            // Accordion Toggle (MODIFIED for adjacent corners)
            window.toggleCard = (id) => {
                const cardEl = document.getElementById(`card-${id}`);
                const detailsEl = document.getElementById(`details-${id}`);
                const arrowEl = document.getElementById(`arrow-${id}`);
                if (!cardEl || !detailsEl || !arrowEl) return; 

                const isOpening = !cardEl.classList.contains('expanded');
                const currentlyOpenCardId = activeCardId; // Store before changing

                // --- Collapse currently open card first, if any ---
                if (currentlyOpenCardId && currentlyOpenCardId !== id) {
                    const oldCardEl = document.getElementById(`card-${currentlyOpenCardId}`);
                    if (oldCardEl) {
                        const oldDetailsEl = document.getElementById(`details-${currentlyOpenCardId}`);
                        const oldArrowEl = document.getElementById(`arrow-${currentlyOpenCardId}`);
                        
                        updateAdjacentCorners(oldCardEl, false); // Remove corner rounding from its neighbors

                        oldCardEl.classList.remove('expanded'); 
                        if (oldDetailsEl) {
                            oldDetailsEl.classList.remove('details-expanded');
                            oldDetailsEl.classList.add('details-collapsed');
                        }
                        if (oldArrowEl) oldArrowEl.classList.remove('rotate-180');
                    }
                }
                
                // --- Toggle the target card ---
                updateAdjacentCorners(cardEl, isOpening); // Add/Remove corner rounding for neighbors

                if (isOpening) {
                    cardEl.classList.add('expanded'); // Add margin class
                    detailsEl.classList.add('details-expanded');
                    detailsEl.classList.remove('details-collapsed');
                    arrowEl.classList.add('rotate-180');
                    activeCardId = id;
                } else {
                    cardEl.classList.remove('expanded'); // Remove margin class
                    detailsEl.classList.remove('details-expanded');
                    detailsEl.classList.add('details-collapsed');
                    arrowEl.classList.remove('rotate-180');
                    activeCardId = null; // Important to set to null if closing the active one
                }
            };


            // Show Message
            const showMessage = (text, isError = false) => {
                messageBox.textContent = text;
                messageBox.className = `fixed bottom-5 right-5 aero-card p-4 text-white ${isError ? 'bg-red-500' : 'bg-green-500'} block`;
                setTimeout(() => { messageBox.className = 'hidden'; }, 3000);
            };

            // Update Status/Stage (MODIFIED to use global userId)
            window.updateStatusAndStage = async (event, id, button) => {
                event.stopPropagation();
                if (!userId) { // Check if user is logged in
                    showMessage("You must be signed in to update.", true);
                    return;
                }
                button.classList.add('is-loading'); button.disabled = true;
                const statusEl = document.getElementById(`status-${id}`);
                const stageEl = document.getElementById(`stage-${id}`);
                const status = statusEl ? statusEl.value : null;
                const stage = stageEl ? stageEl.value : null;
                if (status === null || stage === null) {
                    console.error("Could not find status or stage element for ID:", id);
                    showMessage("Update failed: Internal error.", true);
                    button.classList.remove('is-loading'); button.disabled = false;
                    return;
                }
                // Use the secure, dynamic userId
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/crm_candidates`, id);
                try {
                    await updateDoc(docRef, { STATUS: status, STAGE: stage });
                    showMessage("Update successful!");
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showMessage("Update failed. Check console.", true);
                } finally {
                    button.classList.remove('is-loading'); button.disabled = false;
                }
            };

            // Search Filter
            if (searchBox) { // Only add listener if search box exists (on leads page)
                searchBox.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterFn = (c) => 
                        (c.LeadName && c.LeadName.toLowerCase().includes(searchTerm)) ||
                        (c.CompanyName && c.CompanyName.toLowerCase().includes(searchTerm)) ||
                        (c.LeadRole && c.LeadRole.toLowerCase().includes(searchTerm));
                    renderData(allCandidates.filter(filterFn));
                });
            }
            
            // --- THEME, PARALLAX, AND HEADER ---

            // Apply Theme Class
            const applyTheme = (theme) => {
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            // Theme Toggle Button Click
            themeToggleBtn.addEventListener('click', () => {
                if (themeToggleBtn.disabled) return;
                themeToggleBtn.disabled = true;
                const isDark = !document.documentElement.classList.contains('dark');
                const newTheme = isDark ? 'dark' : 'light';
                const targetBg = isDark ? 'rgba(17, 24, 39, 0.85)' : 'rgba(245, 243, 255, 0.85)';
                const rect = themeToggleBtn.getBoundingClientRect();
                const x = rect.left + rect.width / 2; const y = rect.top + rect.height / 2;
                document.documentElement.style.setProperty('--clip-x', `${x}px`);
                document.documentElement.style.setProperty('--clip-y', `${y}px`);
                themeOverlay.style.backgroundColor = targetBg;
                let clipPathTransitionHandled = false;
                const onClipPathEnd = (e) => {
                    if (clipPathTransitionHandled || (e && e.propertyName !== 'clip-path')) return;
                    clipPathTransitionHandled = true; themeOverlay.removeEventListener('transitionend', onClipPathEnd);
                    applyTheme(newTheme); themeOverlay.classList.add('fading-out');
                    let fadeOutTransitionHandled = false;
                    const onFadeOutEnd = (e) => {
                        if (fadeOutTransitionHandled || (e && e.propertyName !== 'opacity')) return;
                        fadeOutTransitionHandled = true; themeOverlay.removeEventListener('transitionend', onFadeOutEnd);
                        themeOverlay.classList.remove('active', 'fading-out'); themeOverlay.style.backgroundColor = 'transparent'; themeToggleBtn.disabled = false; 
                    };
                    themeOverlay.addEventListener('transitionend', onFadeOutEnd); setTimeout(onFadeOutEnd, 350); 
                };
                themeOverlay.addEventListener('transitionend', onClipPathEnd); setTimeout(onClipPathEnd, 550); 
                requestAnimationFrame(() => { requestAnimationFrame(() => { themeOverlay.classList.add('active'); }); });
                localStorage.setItem('theme', newTheme);
                themeToggleBtn.classList.add('toggling'); setTimeout(() => { themeToggleBtn.classList.remove('toggling'); }, 300);
            });

            // Main Scroll Listener (Parallax)
            if (mainScroller) {
                mainScroller.addEventListener('scroll', () => {
                    const scrollY = mainScroller.scrollTop;
                    const parallaxFast = scrollY * 0.3; const parallaxSlow = parallaxFast * 0.5; const parallaxXSlow = parallaxFast * 0.2;
                    document.body.style.setProperty('--background-scroll-y', `${parallaxFast}px`);
                    document.body.style.setProperty('--background-scroll-y-slow', `${parallaxSlow}px`);
                    document.body.style.setProperty('--background-scroll-y-xslow', `${parallaxXSlow}px`);
                });
                // Card Glow Effect
                mainScroller.addEventListener('mousemove', (e) => {
                    const card = e.target.closest('.aero-card');
                    if (card) {
                        const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                        card.style.setProperty('--x', `${x}px`); card.style.setProperty('--y', `${y}px`);
                    }
                });
            }
            
            // Modal Listeners
            const toggleModal = (visible) => {
                addModalOverlay.classList.toggle('visible', visible);
                addModalContent.classList.toggle('visible', visible);
            };
            addBtn.addEventListener('click', () => toggleModal(true));
            addModalOverlay.addEventListener('click', () => toggleModal(false));
            
            // Smart Filter Panel Toggle
            let isFilterPanelVisible = false;
            window.toggleFilterPanel = (forceState) => { // Allow forcing open/closed
                 // If forceState is provided (true/false), use it, otherwise toggle
                 isFilterPanelVisible = typeof forceState === 'boolean' ? forceState : !isFilterPanelVisible;
                 smartFilterPanel.classList.toggle('visible', isFilterPanelVisible);
            };

            // --- Details Sidebar Logic ---
            let isDetailsSidebarVisible = false;
            window.openDetailsSidebar = (candidateId) => {
                const candidate = allCandidates.find(c => c.id === candidateId);
                if (!candidate) {
                    console.error("Could not find candidate data for ID:", candidateId);
                    return;
                }

                // Populate Sidebar
                document.getElementById('detail-name').textContent = candidate.LeadName || 'N/A';
                document.getElementById('detail-company').textContent = candidate.CompanyName || 'N/A';
                document.getElementById('detail-role').textContent = candidate.LeadRole || 'N/A';
                document.getElementById('detail-notes').textContent = candidate.NOTELS || 'No notes recorded.';
                document.getElementById('detail-phone').textContent = 'N/A'; // Placeholder
                document.getElementById('detail-email').textContent = 'N/A'; // Placeholder

                // Show Sidebar
                document.body.classList.add('details-visible');
                detailsSidebar.classList.add('visible');
                isDetailsSidebarVisible = true;
            };

            window.closeDetailsSidebar = () => {
                document.body.classList.remove('details-visible');
                detailsSidebar.classList.remove('visible');
                isDetailsSidebarVisible = false;
            };

            closeDetailsBtn.addEventListener('click', window.closeDetailsSidebar);
            
            // Changelog Toggle
            if (changelogToggle) {
                 changelogToggle.addEventListener('click', () => {
                     changelogContent.classList.toggle('expanded');
                     changelogArrow.classList.toggle('rotate-180');
                 });
            }


            // Click outside listener for Filter Panel & Details Sidebar
            document.addEventListener('click', (event) => {
                // Click outside filter panel
                if (isFilterPanelVisible && smartFilterPanel && !smartFilterPanel.contains(event.target)) {
                    const isFilterToggleButton = event.target.closest('.sidebar-secondary-btn[title="Smart Filter"]');
                    const isInsideSidebar = event.target.closest('#sidebar');
                    if (!isFilterToggleButton && !isInsideSidebar) { 
                         toggleFilterPanel(false); // Force close
                    }
                }
                
                 // Click outside details sidebar
                if (isDetailsSidebarVisible && detailsSidebar && !detailsSidebar.contains(event.target)) {
                     const isViewButton = event.target.closest('.card-action-button[title="View"]');
                     if (!isViewButton) {
                         window.closeDetailsSidebar();
                     }
                }
            });
            
            // --- Auth Event Handlers ---
            // REMOVED: signInWithGoogle, it's in login.html

            const signOutUser = async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle the redirect to login.html
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Sign-out failed:", error);
                }
            };

            // Attach listeners
            if (signOutBtn) signOutBtn.addEventListener('click', signOutUser);


            // --- START APP ---
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme ? savedTheme : (prefersDark ? 'dark' : 'light'));
            
            initFirebase(); 
        
        }); // END DOMContentLoaded
    </script>
</body>
</html>

